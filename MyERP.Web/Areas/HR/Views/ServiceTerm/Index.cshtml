@{
    ViewData["Title"] = "ضم مدد الخدمة السابقة";
}

<!-- DataTables CSS -->
<link rel="stylesheet" href="~/plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
<link rel="stylesheet" href="~/plugins/datatables-responsive/css/responsive.bootstrap4.min.css">
<link rel="stylesheet" href="~/plugins/datatables-buttons/css/buttons.bootstrap4.min.css">

<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0 text-dark">تسجيل مدد الخدمة السابقة</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="#">التعيينات</a></li>
                    <li class="breadcrumb-item active">ضم الخدمة</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<section class="content">
    <div class="container-fluid">

        <!-- 1. نموذج تسجيل طلب جديد -->
        <div class="card card-info collapsed-card">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-plus-circle mr-1"></i> تسجيل طلب ضم مدة جديد</h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <form asp-action="Create" method="post" enctype="multipart/form-data">
                    <div class="row">
                        <!-- صف البيانات الأساسية -->
                        <div class="col-md-4 mb-3">
                            <label>اسم الموظف</label>
                            <select class="form-control select2">
                                <option>-- ابحث بالاسم او الكود --</option>
                                <option>فاطمة عبدالفتاح الشرباني</option>
                                <option>محمد فؤاد ابراهيم</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label>الجهة السابقة (مكان العمل)</label>
                            <input type="text" class="form-control" placeholder="مثال: التأمينات الاجتماعية / شركة خاصة">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label>نوع المدة</label>
                            <select class="form-control">
                                <option>مدة حكومية (ضم كامل)</option>
                                <option>قطاع خاص (خاضع للتأمينات)</option>
                                <option>مدة تجنيد / خدمة عامة</option>
                            </select>
                        </div>

                        <!-- صف التواريخ والحساب -->
                        <div class="col-md-3 mb-3">
                            <label>تاريخ بداية المدة</label>
                            <input type="date" class="form-control" id="startDate" onchange="calculatePeriod()">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label>تاريخ نهاية المدة</label>
                            <input type="date" class="form-control" id="endDate" onchange="calculatePeriod()">
                        </div>

                        <!-- الحساب التلقائي للفترة -->
                        <div class="col-md-6 mb-3 bg-light p-2 rounded border">
                            <label class="text-primary" style="font-size:13px">صافي المدة المحسوبة:</label>
                            <div class="row text-center">
                                <div class="col-4">
                                    <input type="number" readonly class="form-control form-control-sm" id="calcYear" placeholder="سنة">
                                </div>
                                <div class="col-4">
                                    <input type="number" readonly class="form-control form-control-sm" id="calcMonth" placeholder="شهر">
                                </div>
                                <div class="col-4">
                                    <input type="number" readonly class="form-control form-control-sm" id="calcDay" placeholder="يوم">
                                </div>
                            </div>
                        </div>

                        <!-- المرفقات والملاحظات -->
                        <div class="col-md-6 mb-3">
                            <label>شهادة الخدمة / برينت التأمينات</label>
                            <div class="custom-file">
                                <input type="file" class="custom-file-input" id="customFile">
                                <label class="custom-file-label" for="customFile">ارفاق صورة...</label>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label>ملاحظات (قرار اللجنة)</label>
                            <input type="text" class="form-control" placeholder="رقم قرار الضم إن وجد...">
                        </div>
                    </div>

                    <div class="text-left border-top pt-2">
                        <button type="submit" class="btn btn-info"><i class="fas fa-save"></i> حفظ الطلب</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 2. جدول سجلات الضم (ارشيف) -->
        <div class="card card-outline card-primary">
            <div class="card-header">
                <h3 class="card-title">سجل المدد المضمومة (History)</h3>
                <div class="card-tools">
                    <button class="btn btn-sm btn-outline-success">
                        <i class="fas fa-file-excel"></i> تصدير للكشف
                    </button>
                </div>
            </div>
            <div class="card-body">
                <table id="serviceTable" class="table table-bordered table-hover text-center table-striped">
                    <thead class="bg-dark text-white">
                        <tr>
                            <th>#</th>
                            <th>الموظف</th>
                            <th>الجهة السابقة</th>
                            <th>من تاريخ</th>
                            <th>إلى تاريخ</th>
                            <th>صافي المدة</th>
                            <th>قرار اللجنة</th>
                            <th>تاريخ الأقدمية المعدل</th>
                            <th>خيارات</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- مثال 1: مدة مقبولة -->
                        <tr>
                            <td>1</td>
                            <td class="font-weight-bold">رانيا ابو النصر</td>
                            <td>وزارة العدل (انتداب سابق)</td>
                            <td>01-01-2015</td>
                            <td>01-01-2019</td>
                            <td><span class="badge badge-secondary">4 سنة</span></td>
                            <td><span class="badge badge-success">تم الضم</span></td>
                            <td class="text-success">01-01-2015</td>
                            <td>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-light btn-sm dropdown-toggle border" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-cog"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#"><i class="fas fa-eye text-primary"></i> عرض المرفقات</a></li>
                                        <li><a class="dropdown-item" href="#"><i class="fas fa-print text-dark"></i> طباعة قرار الضم</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item" href="#"><i class="fas fa-trash text-danger"></i> حذف</a></li>
                                    </ul>
                                </div>
                            </td>
                        </tr>

                        <!-- مثال 2: مدة قيد الانتظار -->
                        <tr>
                            <td>2</td>
                            <td class="font-weight-bold">محمد فؤاد ابراهيم</td>
                            <td>شركة السلام للمقاولات</td>
                            <td>01-03-2000</td>
                            <td>01-03-2005</td>
                            <td><span class="badge badge-secondary">5 سنة</span></td>
                            <td><span class="badge badge-warning">تحت المراجعة</span></td>
                            <td>-</td>
                            <td>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-light btn-sm dropdown-toggle border" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-cog"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#"><i class="fas fa-check text-success"></i> اعتماد الضم</a></li>
                                        <li><a class="dropdown-item" href="#"><i class="fas fa-times text-danger"></i> رفض الطلب</a></li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</section>

    <script>
        $(function () {
            // تشغيل الجدول
            $('#serviceTable').DataTable({
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/Arabic.json"
                }
            });

            // تحسين شكل رفع الملفات
             $(".custom-file-input").on("change", function () {
                var fileName = $(this).val().split("\\").pop();
                $(this).siblings(".custom-file-label").addClass("selected").html(fileName);
            });
        });

        // دالة حساب المدة بالجافاسكربت (User Experience)
        function calculatePeriod() {
            var start = document.getElementById("startDate").value;
            var end = document.getElementById("endDate").value;

            if (start && end) {
                var date1 = new Date(start);
                var date2 = new Date(end);

                // حساب الفرق بالملي ثانية
                var diff = date2.getTime() - date1.getTime();

                // لو التاريخ بالسالب (تاريخ النهاية قبل البداية)
                if(diff < 0) {
                    alert("تاريخ النهاية يجب أن يكون بعد البداية");
                    document.getElementById("calcYear").value = "";
                    return;
                }

                var dayCount = diff / (1000 * 3600 * 24);

                // حساب تقريبي للسنوات والشهور والأيام (بسيط للعرض فقط)
                var years = Math.floor(dayCount / 365);
                var remainingDays = dayCount % 365;
                var months = Math.floor(remainingDays / 30);
                var days = Math.floor(remainingDays % 30);

                document.getElementById("calcYear").value = years;
                document.getElementById("calcMonth").value = months;
                document.getElementById("calcDay").value = days;
            }
        }
    </script>
